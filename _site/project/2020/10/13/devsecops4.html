<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <meta name="viewport" content="width=device-width, initial-scale=1 maximum-scale=1; minimum-scale=1; user-scalable=no;"> <meta content="[Project] DevSecOps 프로젝트 - Helm을 통한 모니터링과 로깅 시스템 구축" name="description"> <meta name="keywords" content="son,blog,project,devsecops,devops,gcp,kubernetes,helm,prometheus,grafana,efk"> <meta name="author" content="son"> <meta name="baseurl" content=""> <title> son | [Project] DevSecOps 프로젝트 - Helm을 통한 모니터링과 로깅 시스템 구축 </title> <!-- favicon --> <link rel="shortcut icon" href="/static/assets/img/favicon.ico"> <!-- Main CSS --> <link href="/static/assets/app-20200311.min.css" rel="stylesheet"> <link href="/static/css/custom.css" rel="stylesheet"> <!-- Main Scripts --> <script src="/static/assets/app-20200311.min.js"></script> <script src="/static/assets/blog-20200311.min.js"></script> <!-- Google AdSense --> <script async src="//pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script> <script> (adsbygoogle = window.adsbygoogle || []).push({ google_ad_client: "ca-pub-6196184620200311", enable_page_level_ads: true }); </script> </head> <body id="page-top" class="landing-page"> <div class="search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right: 0px; opacity: 0.95; background-color: #111111; z-index: 9999; display: none;"> <input type="text" class="form-control search-content" id="search-content" style="position: fixed; top: 60px" placeholder="Search Blog"> <div style="position: fixed; top: 16px; right: 16px; z-index: 9999;"> <img src="/static/assets/img/search/cb-close.png" id="close-btn"/> </div> </div> <div style="position: fixed; right: 16px; bottom: 20px; z-index: 9999;"> <img src="/static/assets/img/search/cb-search.png" id="search-btn" title="Double click Ctrl"/> </div> <div class="navbar-wrapper"> <nav class="navbar navbar-default navbar-fixed-top" role="navigation"> <div class="container"> <div class="navbar-header page-scroll"> <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar"></span> <span class="icon-bar"></span> <span class="icon-bar"></span> </button> <a class="navbar-brand" href="/">son</a> </div> <div id="navbar" class="navbar-collapse collapse"> <ul class="nav navbar-nav navbar-right"> <li><a class="page-scroll" href="blog/"></a></li> <li> <a class="page-scroll" href="/blog/">All</a></li> <li> <a class="page-scroll" href="/project/">Project</a></li> <li> <a class="page-scroll" href="/research/">Research</a></li> <li> <a class="page-scroll" href="/troubleshooting/">Troubleshooting</a></li> <li> <a class="page-scroll" href="/infra/">Infra</a></li> <li> <a class="page-scroll" href="/data/">Data</a></li> <li> <a class="page-scroll" href="/anything/">Anything</a></li> </ul> </div> </div> </nav> </div> <div id="inSlider" class="carousel carousel-fade" data-ride="carousel"> <ol class="carousel-indicators"> <li data-target="#inSlider" data-slide-to="0" class="active"></li> <li data-target="#inSlider" data-slide-to="1"></li> <li data-target="#inSlider" data-slide-to="2"></li> </ol> <div class="carousel-inner" role="listbox"> <div class="item active"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_one.jpg);" title="han-gi's blog"> </div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_two.jpg);" title="han-gi's blog"></div> </div> <div class="item"> <div class="container"> <div class="carousel-caption"> </div> <div class="carousel-image wow zoomIn"> <!-- <img src="static/img/landing/laptop.png" alt="laptop"/> --> </div> </div> <!-- Set background for slide in css --> <div class="header-back" style="background-image: url(/static/assets/img/landing/header_three.jpg);" title="han-gi's blog"></div> </div> </div> <a class="left carousel-control" href="#inSlider" role="button" data-slide="prev"> <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span> <span class="sr-only">Previous</span> </a> <a class="right carousel-control" href="#inSlider" role="button" data-slide="next"> <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span> <span class="sr-only">Next</span> </a> </div> <div class="wrapper wrapper-content animated fadeInRight article"> <div class="row"> <div class="col-lg-10 col-lg-offset-1"> <div class="ibox"> <div class="ibox-content"> <div class="pull-right"> <a class="btn btn-white btn-xs" href="/project">Project</a> </div> <div class="text-center article-title"> <span class="text-muted"><i class="fa fa-clock-o"></i> 13 Oct 2020</span> <h1> [Project] DevSecOps 프로젝트 - Helm을 통한 모니터링과 로깅 시스템 구축 </h1> </div> <!-- <article class="post-article"> <div class="toc"> <a href="#"><b>⬆️ go to top ⬆️</b></a> <ul><li><a href="#목차">목차</a></li><li><a href="#1-모니터링-시스템-구축---"><span style="color:purple"><strong>1. 모니터링 시스템 구축</strong></span> <a name="list1"></a></a></li><li><a href="#2-로깅-시스템-구축---"><span style="color:purple"><strong>2. 로깅 시스템 구축</strong></span> <a name="list2"></a></a></li></ul> </div> </article> --> <h2 id="목차">목차</h2> <p><a href="#list1">1. 모니터링 시스템 구축</a></p> <p><a href="#list1_1">   1.1. Helm 개요와 설치</a></p> <p><a href="#list1_2">   1.2. Prometheus와 Grafana 구성</a></p> <p><a href="#list2">2. 로깅 시스템 구축</a></p> <p><a href="#list2_1">   2.1. EFK(Elasticsearch-Fluent Bit-Kibana) 구성</a></p> <hr /> <h2 id="1-모니터링-시스템-구축---"><span style="color:purple"><strong>1. 모니터링 시스템 구축</strong></span> <a name="list1"></a></h2> <p><br /></p> <ul> <li> <p><strong>Helm 개요와 설치</strong> <a name="list1_1"></a></p> <p>Helm은 쿠버네티스 패키지를 관리해주는 도구이다.</p> <p>Helm에서 사용되는 차트는 리소스를 하나로 묶은 패키지에 해당하며, Helm으로 차트를 관리하는 목적은 자칫 번잡해지기 쉬운 매니페스트 파일을 관리하기 쉽게 하기 위함이다.</p> <p>그리고 설치할 때마다 릴리스 버전이 생성되고 새로운 차트를 찾을때에는 Helm chart repository에서 찾을 수 있다.</p> <p>Helm 다음 명령어로 간단하게 설치가 가능하다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>curl <span class="nt">-fsSL</span> <span class="nt">-o</span> get_helm.sh https://raw.githubusercontent.com/helm/helm/master/scripts/get-helm-3
  <span class="nv">$ </span><span class="nb">chmod </span>700 get_helm.sh
  <span class="nv">$ </span>./get_helm.sh
</code></pre></div> </div> <p>Helm이 정상적으로 설치되면 차트 레포지토리를 추가하고 업데이트 해준다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>helm repo add stable https://kubernetes-charts.storage.googleapis.com/
  <span class="s2">"stable"</span> has been added to your repositories

  <span class="nv">$ </span>helm repo update
  Hang tight <span class="k">while </span>we grab the latest from your chart repositories...
  ...Successfully got an update from the <span class="s2">"stable"</span> chart repository
  Update Complete. ⎈Happy Helming!⎈
</code></pre></div> </div> <p>여기까지만 해주어도 Helm을 사용할 준비가 끝난 것이다.</p> <p><br /></p> </li> <li> <p><strong>Prometheus와 Grafana 구성</strong> <a name="list1_2"></a></p> <p>모니터링 환경을 구축하기 위해 앞서 설치한 Helm을 사용하여 Prometheus와 Grafana를 쿠버네티스에 설치할 것이다.</p> <p>먼저 모니터링을 위한 네임스페이스를 생성해준다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>kubectl create namespace monitoring
  namemonitoring created
</code></pre></div> </div> <p>생성된 네임스페이스에 다음 명령어를 통해 prometheus-operator를 설치해준다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>helm <span class="nb">install </span>prometheus stable/prometheus-operator <span class="nt">--namespace</span> monitoring
  WARNING: This chart is deprecated
  manifest_sorter.go:192: info: skipping unknown hook: <span class="s2">"crd-install"</span>
  manifest_sorter.go:192: info: skipping unknown hook: <span class="s2">"crd-install"</span>
  manifest_sorter.go:192: info: skipping unknown hook: <span class="s2">"crd-install"</span>
  manifest_sorter.go:192: info: skipping unknown hook: <span class="s2">"crd-install"</span>
  manifest_sorter.go:192: info: skipping unknown hook: <span class="s2">"crd-install"</span>
  manifest_sorter.go:192: info: skipping unknown hook: <span class="s2">"crd-install"</span>
  NAME: prometheus
  LAST DEPLOYED: Sun Oct  4 07:36:07 2020
  NAMESPACE: monitoring
  STATUS: deployed
  REVISION: 1
  NOTES:
  <span class="k">*******************</span>
  <span class="k">***</span> DEPRECATED <span class="k">****</span>
  <span class="k">*******************</span>
  <span class="k">*</span> stable/prometheus-operator chart is deprecated.
  <span class="k">*</span> Further development has moved to https://github.com/prometheus-community/helm-charts
  <span class="k">*</span> The chart has been renamed kube-prometheus-stack to more clearly reflect
  <span class="k">*</span> that it installs the <span class="sb">`</span>kube-prometheus<span class="sb">`</span> project stack, within which Prometheus
  <span class="k">*</span> Operator is only one component.

  The Prometheus Operator has been installed. Check its status by running:
  kubectl <span class="nt">--namespace</span> monitoring get pods <span class="nt">-l</span> <span class="s2">"release=prometheus"</span>

  Visit https://github.com/coreos/prometheus-operator <span class="k">for </span>instructions on how
  to create &amp; configure Alertmanager and Prometheus instances using the Operator.
</code></pre></div> </div> <p>Prometheus와 Grafana가 재대로 동작하는지 확인해본다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>kubectl get all <span class="nt">-n</span> monitoring
  NAME                                                         READY   STATUS    RESTARTS   AGE
  pod/alertmanager-prometheus-prometheus-oper-alertmanager-0   2/2     Running   0          10m
  pod/prometheus-grafana-7db88cd4c6-nff9b                      2/2     Running   0          10m
  pod/prometheus-kube-state-metrics-6b46f67bf6-n8pxk           1/1     Running   0          10m
  pod/prometheus-prometheus-node-exporter-d4zfh                1/1     Running   0          10m
  pod/prometheus-prometheus-node-exporter-dkjrj                1/1     Running   0          10m
  pod/prometheus-prometheus-node-exporter-zv7t9                1/1     Running   0          10m
  pod/prometheus-prometheus-oper-operator-7c75ff5864-z85j8     2/2     Running   0          10m
  pod/prometheus-prometheus-prometheus-oper-prometheus-0       3/3     Running   0          10m

  NAME                                              TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>                      AGE
  service/alertmanager-operated                     ClusterIP   None             &lt;none&gt;        9093/TCP,9094/TCP,9094/UDP   10m
  service/prometheus-grafana                        ClusterIP   10.104.145.38    &lt;none&gt;        80/TCP                       10m
  service/prometheus-kube-state-metrics             ClusterIP   10.109.220.132   &lt;none&gt;        8080/TCP                     10m
  service/prometheus-operated                       ClusterIP   None             &lt;none&gt;        9090/TCP                     10m
  service/prometheus-prometheus-node-exporter       ClusterIP   10.104.66.36     &lt;none&gt;        9100/TCP                     10m
  service/prometheus-prometheus-oper-alertmanager   ClusterIP   10.100.159.72    &lt;none&gt;        9093/TCP                     10m
  service/prometheus-prometheus-oper-operator       ClusterIP   10.99.75.140     &lt;none&gt;        8080/TCP,443/TCP             10m
  service/prometheus-prometheus-oper-prometheus     NodePort    10.107.124.62    &lt;none&gt;        9090/TCP                     10m

  NAME                                                 DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR   AGE
  daemonset.apps/prometheus-prometheus-node-exporter   3         3         3       3            3           &lt;none&gt;          10m
</code></pre></div> </div> <p>Prometheus와 Grafana가 정상적으로 동작하면 <code class="language-plaintext highlighter-rouge">NodePort를 생성</code>하여 생성된 Prometheus와 Grafana 서비스에 접근할 수 있다.</p> <p>본 프로젝트에서는 Prometheus의 포트번호를 31111, Grafana의 포트번호를 31112로 정하였고, <strong>GCP 방화벽에서도 해당 포트를 열어준다.</strong></p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vim prometheus_nodeport.yaml
  apiVersion: v1
  kind: Service
  metadata:
  name: prometheus
  spec:
  <span class="nb">type</span>: NodePort
  selector:
      app: prometheus
      prometheus: prometheus-prometheus-oper-prometheus
  ports:
      - protocol: TCP
      port: 9090
      targetPort: 9090
      nodePort: 31111

  <span class="nv">$ </span>vim grafana_nodeport.yaml 
  apiVersion: v1
  kind: Service
  metadata:
  name: grafana
  spec:
  <span class="nb">type</span>: NodePort
  selector:
      app.kubernetes.io/instance: prometheus
      app.kubernetes.io/name: grafana
  ports:
      - protocol: TCP
      port: 3000
      targetPort: 3000
      nodePort: 31112

  <span class="nv">$ </span>kubectl create <span class="nt">-f</span> prometheus_nodeport.yaml <span class="nt">-n</span> monitoring
  <span class="nv">$ </span>kubectl create <span class="nt">-f</span> grafana_nodeport.yaml <span class="nt">-n</span> monitoring
</code></pre></div> </div> <p><code class="language-plaintext highlighter-rouge">kube-masterIP:31111</code> URL로 접속하여 상단 메뉴의 <code class="language-plaintext highlighter-rouge">Status &gt; Targets</code>에 들어가보면 다음 [그림 1]과 같이 에러가 발생되어 있을 수 있다.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/static/assets/img/landing/project/devsecops_4_1.png" alt="proxy_etcd_error" width="858" height="254" /></th> </tr> </thead> <tbody> <tr> <td style="text-align: center">[그림 1] kube-proxy와 kube-etcd 에러</td> </tr> </tbody> </table> <p><br /></p> <p>kube-proxy는 메트릭 바인드 주소가 기본적으로 localhost로 잡혀있을 것이다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>kubectl edit cm/kube-proxy <span class="nt">-n</span> kube-system
  ...<span class="o">(</span>중략<span class="o">)</span>
  kind: KubeProxyConfiguration
  metricsBindAddress: 0.0.0.0:10249
  ...<span class="o">(</span>중략<span class="o">)</span>

  <span class="nv">$ </span>kubectl delete pod <span class="nt">-l</span> k8s-app<span class="o">=</span>kube-proxy <span class="nt">-n</span> kube-system
</code></pre></div> </div> <p>metricsBindAddress 값을 위와 같이 0.0.0.0으로 바꿔주고 기존의 kube-proxy 파드를 제거하여 재생성 되도록 해주면 Prometheus에서 kube-proxy가 정상적으로 작동할 것이다.</p> <p>다음으로 kube-etcd는 https 인증서 설정이 재대로 되어있지 않아서 생기는 문제이다.</p> <p>prometheus-operator를 배포할 때 Helm 차트의 values.yaml 파일을 다음과 같이 수정한다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vim values.yaml
  serviceMonitor:
      scheme: https
      insecureSkipVerify: <span class="nb">false
      </span>serverName: localhost
      caFile: /etc/prometheus/secrets/etcd-client-cert/etcd-ca
      certFile: /etc/prometheus/secrets/etcd-client-cert/etcd-client
      keyFile: /etc/prometheus/secrets/etcd-client-cert/etcd-client-key

      secrets:
      - <span class="s2">"etcd-client-cert"</span>
</code></pre></div> </div> <p>values.yaml 파일을 수정하고 caFile, certFile, keyFile에 맞는 시크릿을 생성해주어야 한다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ POD_NAME</span><span class="o">=</span><span class="si">$(</span>kubectl get pods <span class="nt">-o</span><span class="o">=</span><span class="nv">jsonpath</span><span class="o">=</span><span class="s1">'{.items[0].metadata.name}'</span> <span class="nt">-l</span> <span class="nv">component</span><span class="o">=</span>kube-apiserver <span class="nt">-n</span> kube-system<span class="si">)</span>
  <span class="nv">$ </span>kubectl create secret generic etcd-client-cert <span class="nt">-n</span> monitoring <span class="se">\</span>
  <span class="nt">--from-literal</span><span class="o">=</span>etcd-ca<span class="o">=</span><span class="s2">"</span><span class="si">$(</span>kubectl <span class="nb">exec</span> <span class="nv">$POD_NAME</span> <span class="nt">-n</span> kube-system <span class="nt">--</span> <span class="nb">cat</span> /etc/kubernetes/pki/etcd/ca.crt<span class="si">)</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--from-literal</span><span class="o">=</span>etcd-client<span class="o">=</span><span class="s2">"</span><span class="si">$(</span>kubectl <span class="nb">exec</span> <span class="nv">$POD_NAME</span> <span class="nt">-n</span> kube-system <span class="nt">--</span> <span class="nb">cat</span> /etc/kubernetes/pki/etcd/healthcheck-client.crt<span class="si">)</span><span class="s2">"</span> <span class="se">\</span>
  <span class="nt">--from-literal</span><span class="o">=</span>etcd-client-key<span class="o">=</span><span class="s2">"</span><span class="si">$(</span>kubectl <span class="nb">exec</span> <span class="nv">$POD_NAME</span> <span class="nt">-n</span> kube-system <span class="nt">--</span> <span class="nb">cat</span> /etc/kubernetes/pki/etcd/healthcheck-client.key<span class="si">)</span><span class="s2">"</span>
  secret/etcd-client-cert created
</code></pre></div> </div> <p>etcd-client-cert 시크릿을 만들어주고 수정된 values.yaml 파일을 바탕으로 다시 prometheus-operator를 배포하면 etcd의 통신 에러도 해결 될 것이다.</p> <p>Helm에 value.xml 파일을 따로 수정하지 않으면 기본적으로 Grafana의 ID는 <code class="language-plaintext highlighter-rouge">admin</code>, 패스워드는 <code class="language-plaintext highlighter-rouge">prom-operator</code>로 설정되어 있다.</p> <p>참고로 초기 패스워드는 values.yaml 파일에서 수정할 수 있다.</p> <p><code class="language-plaintext highlighter-rouge">kube-masterIP:31112</code> URL로 접속하여 Grafana 대시보드가 Prometheus에서 수집된 메트릭을 잘 수집하여 시각화되어지는지 확인해본다.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/static/assets/img/landing/project/devsecops_4_2.png" alt="grafana_dashboard" /></th> </tr> </thead> <tbody> <tr> <td style="text-align: center">[그림 2] Grafana 대시보드 확인</td> </tr> </tbody> </table> <p><br /></p> <p>위의 [그림 2]에서와 같이 쿠버네티스 클러스터에 대한 메트릭이 잘 수집되어 시각화해주는 것을 확인할 수 있다.</p> <p><br /></p> </li> </ul> <h2 id="2-로깅-시스템-구축---"><span style="color:purple"><strong>2. 로깅 시스템 구축</strong></span> <a name="list2"></a></h2> <p><br /></p> <ul> <li> <p><strong>EFK(Elasticsearch-Fluent Bit-Kibana) 구성</strong> <a name="list2_1"></a></p> <p>로깅 환경을 구축하기 위해 Helm을 사용하여 EFK를 쿠버네티스에 설치할 것이다.</p> <p>먼저 EFK 차트 레포지토리를 추가 및 업데이트를 해준다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>helm repo add akomljen-charts https://raw.githubusercontent.com/komljen/helm-charts/master/charts/
  <span class="nv">$ </span>helm repo update
</code></pre></div> </div> <p>그런 다음 모니터링과 마찬가지로 로깅을 위한 네임스페이스를 생성해준다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>kubectl create namespace logging
</code></pre></div> </div> <p>elasticsearch-master와 elasticsearch-data에서 사용할 PV를 미리 각각 생성해주어야 PVC가 정상적으로 바인딩 되어 Elasticsearch 노드들이 정상적으로 동작된다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vim elastic-pv.yaml
  apiVersion: v1
  kind: PersistentVolume
  metadata:
  name: es-data-es-master-efk-cluster-default-0
  labels:
      cluster: efk-cluster
      component: elasticsearch-efk-cluster
      name: es-master-efk-cluster-default
      role: master
  spec:
  capacity:
      storage: 10Gi
  accessModes:
      - ReadWriteOnce
  hostPath:
      path: <span class="s2">"/mnt/data"</span>

  <span class="nt">---</span>
  apiVersion: v1
  kind: PersistentVolume
  metadata:
  name: es-data-es-data-efk-cluster-default-0
  labels:
      cluster: efk-cluster
      component: elasticsearch-efk-cluster
      name: es-data-efk-cluster-default
      role: data
  spec:
  capacity:
      storage: 10Gi
  accessModes:
      - ReadWriteOnce
  hostPath:
      path: <span class="s2">"/mnt/data"</span>

  <span class="nv">$ </span>kubectl create <span class="nt">-f</span> elastic-pv.yaml <span class="nt">-n</span> logging

  <span class="nv">$ </span>kubectl get pv,pvc <span class="nt">-n</span> logging
  NAME                                                       CAPACITY   ACCESS MODES   RECLAIM POLICY   STATUS   CLAIM                                             STORAGECLASS   REASON   AGE
  persistentvolume/es-data-es-data-efk-cluster-default-0     10Gi       RWO            Retain           Bound    logging/es-data-es-data-efk-cluster-default-0                             15m
  persistentvolume/es-data-es-master-efk-cluster-default-0   10Gi       RWO            Retain           Bound    logging/es-data-es-master-efk-cluster-default-0                           15m

  NAME                                                            STATUS   VOLUME                                    CAPACITY   ACCESS MODES   STORAGECLASS   AGE
  persistentvolumeclaim/es-data-es-data-efk-cluster-default-0     Bound    es-data-es-data-efk-cluster-default-0     10Gi       RWO                           15m
  persistentvolumeclaim/es-data-es-master-efk-cluster-default-0   Bound    es-data-es-master-efk-cluster-default-0   10Gi       RWO                           15m
</code></pre></div> </div> <p>PV를 정상적으로 생성하고 PVC가 바운드된 것이 확인되면 다음 명령어를 통해 EFK를 설치해준다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>helm <span class="nb">install </span>efk <span class="nt">--namespace</span> logging akomljen-charts/efk

  <span class="nv">$ </span>kubectl get all <span class="nt">-n</span> logging
  NAME                                                    READY   STATUS      RESTARTS   AGE
  pod/efk-elasticsearch-curator-1602579600-rcwk8          0/1     Completed   0          15m
  pod/efk-kibana-676fb9dbd4-rx5xv                         1/1     Running     0          15m
  pod/elasticsearch-operator-sysctl-fl7jd                 1/1     Running     0          15m
  pod/elasticsearch-operator-sysctl-mgsxp                 1/1     Running     0          15m
  pod/es-client-efk-cluster-5f65d7f687-hpm65              1/1     Running     0          15m
  pod/es-data-efk-cluster-default-0                       1/1     Running     0          15m
  pod/es-master-efk-cluster-default-0                     1/1     Running     0          15m
  pod/es-operator-elasticsearch-operator-876b46db-s84t8   1/1     Running     0          15m
  pod/fluent-bit-s5j8z                                    1/1     Running     0          15m
  pod/fluent-bit-spwj2                                    1/1     Running     0          15m


  NAME                                          TYPE        CLUSTER-IP       EXTERNAL-IP   PORT<span class="o">(</span>S<span class="o">)</span>         AGE
  service/efk-kibana                            ClusterIP   10.111.218.138   &lt;none&gt;        443/TCP         15m
  service/elasticsearch-discovery-efk-cluster   ClusterIP   10.103.53.150    &lt;none&gt;        9300/TCP        15m
  service/elasticsearch-efk-cluster             ClusterIP   10.108.108.5     &lt;none&gt;        9200/TCP        15m
  service/es-data-svc-efk-cluster               ClusterIP   10.107.231.1     &lt;none&gt;        9300/TCP        15m

  NAME                                           DESIRED   CURRENT   READY   UP-TO-DATE   AVAILABLE   NODE SELECTOR                 AGE
  daemonset.apps/elasticsearch-operator-sysctl   2         2         2       2            2           beta.kubernetes.io/os<span class="o">=</span>linux   15m
  daemonset.apps/fluent-bit                      2         2         2       2            2           &lt;none&gt;                        15m

  NAME                                                 READY   UP-TO-DATE   AVAILABLE   AGE
  deployment.apps/efk-kibana                           1/1     1            1           15m
  deployment.apps/es-client-efk-cluster                1/1     1            1           15m
  deployment.apps/es-operator-elasticsearch-operator   1/1     1            1           15m

  NAME                                                          DESIRED   CURRENT   READY   AGE
  replicaset.apps/efk-kibana-676fb9dbd4                         1         1         1       15m
  replicaset.apps/es-client-efk-cluster-5f65d7f687              1         1         1       15m
  replicaset.apps/es-operator-elasticsearch-operator-876b46db   1         1         1       15m

  NAME                                             READY   AGE
  statefulset.apps/es-data-efk-cluster-default     1/1     15m
  statefulset.apps/es-master-efk-cluster-default   1/1     15m

  NAME                                             COMPLETIONS   DURATION   AGE
  job.batch/efk-elasticsearch-curator-1602579600   1/1           2s         15m

  NAME                                      SCHEDULE    SUSPEND   ACTIVE   LAST SCHEDULE   AGE
  cronjob.batch/efk-elasticsearch-curator   0 <span class="k">*</span> <span class="k">*</span> <span class="k">*</span> <span class="k">*</span>   False     0        15m             15m
</code></pre></div> </div> <p>EFK가 정상적으로 설치되면 NodePort 서비스를 생성하여 외부에서 접근 가능하도록 해준다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vim kibana-nodeport.yaml
  apiVersion: v1
  kind: Service
  metadata:
  name: kibana
  spec:
  <span class="nb">type</span>: NodePort
  selector:
      app: kibana
      release: efk
  ports:
      - protocol: TCP
      port: 443
      targetPort: 5601
      nodePort: 30443

  <span class="nv">$ </span>kubectl create <span class="nt">-f</span> kibana-nodeport.yaml <span class="nt">-n</span> logging
</code></pre></div> </div> <p>마찬가지로 <strong>Kibana에 접근할 30443 포트는 GCP 방화벽에서도 열어주어야 접근이 가능하다.</strong></p> <p><br /></p> <p>이렇게 Kibana에 접근하더라도 한 가지 문제가 있다.</p> <p>Fluent Bit에서 쿠버네티스 클러스터의 로그를 수집할 때 <code class="language-plaintext highlighter-rouge">/var/log/containers</code>에 존재하는 로그 파일을 읽어들이는데, journald 드라이버를 사용하여 컨테이너 로그를 수집하게 되어 있어 /var/log/containers 폴더에 로그가 쌓이지 않는 문제가 있다.</p> <p>그래서 Kibana에 접속하더라도 생성할 인덱스 패턴이 존재하지 않았었는데, 문제를 해결하기 위해 다음과 같이 수정해야 한다.</p> <div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>  <span class="nv">$ </span>vim /etc/sysconfig/docker
  <span class="nv">OPTIONS</span><span class="o">=</span><span class="s1">'--selinux-enabled --signature-verification=false'</span>
</code></pre></div> </div> <p>모든 쿠버네티스 클러스터에서 /etc/sysconfig/docker 파일에 존재하는 <code class="language-plaintext highlighter-rouge">--log-driver = journald 부분을 제거</code>해야 도커 컨테이너 로그가 /var/log/containers 경로에 쌓이게 되고, Fluent Bit에서 해당 로그들을 수집하여 Kibana에서 인덱스 패턴을 생성할 수 있게 된다.</p> <p>정상적으로 로그가 쌓이게 되면 다시 Kibana에 접속하여 <code class="language-plaintext highlighter-rouge">Kubernetes_cluster-*</code>이라는 인덱스 패턴을 생성해준다.</p> <table> <thead> <tr> <th style="text-align: center"><img src="/static/assets/img/landing/project/devsecops_4_3.png" alt="kibana_index_pattern" width="1233" height="608" /></th> </tr> </thead> <tbody> <tr> <td style="text-align: center">[그림 3] Kibana 인덱스 패턴 확인</td> </tr> </tbody> </table> <p><br /></p> <p>여기까지 Helm을 이용하여 쿠버네티스에 로깅 및 모니터링 시스템을 구축해보았다.</p> <p>다음 포스팅에서는 Jenkins와 Slack을 연동하고 멀티 브랜치를 기반으로 작동하는 파이프라인을 생성하고 스크립트를 작성하는 부분에 대해 기술해보겠다!</p> </li> </ul> <hr> <div class="row"> <div class="col-md-6"> <h5 style="display: inline;">Tags:</h5> <button class="btn btn-white btn-xs" type="button">son</button> <button class="btn btn-white btn-xs" type="button">blog</button> <button class="btn btn-white btn-xs" type="button">project</button> <button class="btn btn-white btn-xs" type="button">devsecops</button> <button class="btn btn-white btn-xs" type="button">devops</button> <button class="btn btn-white btn-xs" type="button">gcp</button> <button class="btn btn-white btn-xs" type="button">kubernetes</button> <button class="btn btn-white btn-xs" type="button">helm</button> <button class="btn btn-white btn-xs" type="button">prometheus</button> <button class="btn btn-white btn-xs" type="button">grafana</button> <button class="btn btn-white btn-xs" type="button">efk</button> </div> <div class="col-md-6"> <div class="small text-right"> <div> <i class="fa fa-comments-o"> </i> <span class="disqus-comment-count" data-disqus-url="http://192.168.116.128:4000/project/2020/10/13/devsecops4.html">0</span> comments </div> </div> </div> </div> <div class="PageNavigation"> <a class="prev" href="/project/2020/10/11/devsecops3.html">&laquo; [Project] DevSecOps 프로젝트 - CD 구성</a> <a class="next" href="/project/2020/10/15/devsecops5.html">[Project] DevSecOps 프로젝트 - Jenkins와 Slack 연동 그리고 멀티 브랜치 파이프라인의 사용 &raquo;</a> </div> <br> <div class="row"> <div class="col-lg-12"> <!-- donate --> <br> <!-- share --> <div class="a2a_kit a2a_kit_size_32 a2a_default_style"> <a class="a2a_dd" href="https://www.addtoany.com/share"></a> <a class="a2a_button_facebook"></a> <a class="a2a_button_twitter"></a> <a class="a2a_button_google_plus"></a> <a class="a2a_button_linkedin"></a> <a class="a2a_button_email"></a> <a class="a2a_button_wechat"></a> <a class="a2a_button_sina_weibo"></a> <a class="a2a_button_pocket"></a> </div> <script> var a2a_config = a2a_config || {}; a2a_config.color_main = "D7E5ED"; a2a_config.color_border = "AECADB"; a2a_config.color_link_text = "333333"; a2a_config.color_link_text_hover = "333333"; </script> <script async src="https://static.addtoany.com/menu/page.js"></script> <br> <!-- comment --> <div id="disqus_thread"></div> <script> /** * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS. * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables */ /* var disqus_config = function () { this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable }; */ (function() { var d = document, s = d.createElement('script'); s.src = '//son.disqus.com/embed.js'; s.setAttribute('data-timestamp', +new Date()); (d.head || d.body).appendChild(s); })(); </script> <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" rel="nofollow">comments powered by Disqus.</a></noscript> </div> </div> </div> </div> </div> </div> </div> <script> function getTOCNodes(master) { var nodes = Array.prototype.slice.call(master.getElementsByTagName("*"), 0); var tocNodes = nodes.filter(function(elem) { return elem.tagName == "A"; }); return tocNodes; } function getHeaderNodes(master) { var nodes = Array.prototype.slice.call(master.getElementsByTagName("*"), 0); var headerNodes = nodes.filter(function(elem) { return elem.tagName == "H1" || elem.tagName == "H2" || elem.tagName == "H3" || elem.tagName == "H4" || elem.tagName == "H5" || elem.tagName == "H6"; }); return headerNodes; } var title = document.getElementsByClassName("article-title")[0]; var titleY = window.pageYOffset + title.getBoundingClientRect().top; var article = document.getElementsByClassName("post-article")[0]; var articleY = window.pageYOffset + article.getBoundingClientRect().top; var toc = document.getElementsByClassName("toc")[0]; var headerNodes = getHeaderNodes(article); var tocNodes = getTOCNodes(toc); var before = undefined; document.body.addEventListener('scroll', function(e) { if (window.scrollY >= articleY-60) { toc.style.cssText = "position: fixed; top: 60px;"; } else { toc.style.cssText = ""; } var current = headerNodes.filter(function(header) { var headerY = window.pageYOffset + header.getBoundingClientRect().top; return window.scrollY >= headerY - 60; }); if (current.length > 0) { current = current[current.length-1]; var currentA = tocNodes.filter(function(tocNode) { return tocNode.innerHTML == current.innerHTML; }) currentA = currentA[0]; if (currentA) { if (before == undefined) before = currentA; if (before != currentA) { before.classList.remove("toc-active"); before = currentA; } currentA.classList.add("toc-active"); } else { if (before) before.classList.remove("toc-active"); } } else { if (before) before.classList.remove("toc-active"); } }, false); </script> <!-- Google analytics --> <script> (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){ (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o), m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m) })(window,document,'script','https://www.google-analytics.com/analytics.js','ga'); ga('create', 'UA-93473370-3', 'auto'); ga('require', ''); ga('send', 'pageview'); </script> <!-- GrowingIO --> <script id="dsq-count-scr" src="https://son.disqus.com/count.js" async></script> </body> </html>
